---
- name: install cloudformation build dependencies
  shell: /usr/bin/pip install -r /vagrant/cloudformation/requirements.txt

- name: install python-pip 
  yum: name={{ item }} state=latest enablerepo=epel-testing
  with_items:
  - python-pip

- name: install aws cli for cloudformation deployment
  shell: pip install awscli

- name: create AWS EC2 Keys
  shell: chdir=/vagrant/cloudformation python demokeys.py create --region {{ aws_region }} creates=/vagrant/cloudformation/keyparams.json

- name: generate cloudformation template
  shell: chdir=/vagrant/cloudformation creates=/vagrant/cloudformation/{{ cf_template_name | default('elkenvironment.debug.template') }} python cfgenerator.py build local_dev_args.json --aws_region {{ aws_region }} --s3_bucket {{ s3_bucket }} --output_file {{ cf_template_name | default('elkenvironment.debug.template') }}

- name: upload template to s3_bucket
  shell: creates=/vagrant/cloudformation/upload.log aws s3 cp /vagrant/cloudformation/{{ cf_template_name | default('elkenvironment.debug.template') }} s3://{{ s3_bucket }}/{{ cf_template_name | default('elkenvironment.debug.template') }} --region {{ aws_region }} > /vagrant/cloudformation/upload.log

- name: deploy cloudformation to AWS
  cloudformation: 
    stack_name: "ansible-elk-cloudformation"
    state: "present"
    region: "{{ aws_region | default('us-west-2') }}"
    template: "/vagrant/cloudformation/{{ cf_template_name | default('elkenvironment.debug.template') }}"
    template_parameters:
      bastionEc2Key: "{{ bastion_key_type | default('bastionInstanceKey') }}"
      bastionInstanceType: "{{ bastion_instance_type | default('t1.micro') }}"
      ec2Key: "{{ ec2_key_name | default('demoInstanceKey')}}"
      elasticsearchClusterName: "{{ elasticsearch_cluster_name | default('ElkDemo') }}"
      logstasnIndexerMaxClusterSize: "{{ logstash_indexer_max_cluster_size | default('4') }}"
      natInstanceType: "{{ nat_instance_type | default('m1.small') }}"
      remoteAccessLocation: "{{ remoteAccessLocation | default('0.0.0.0/0' )}}"